---
title: "QC Report"
date: "`r Sys.Date()`"
author: "`r paste0('gimap (v', utils::packageVersion('gimap'), ')')`"
params:
  dataset: NULL
  plots_dir: ./plots
output: 
  html_document:
    theme: spacelab
    toc: true
    toc_float: TRUE
    df_print: kable
    code_folding: show
  pdf_document:
    toc: true
  always_allow_html: yes
  editor_options:
    chunk_output_type:console
---

<style>
  tbody tr:nth-child(odd){
    background-color: #D6E0F5;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(progress = TRUE, verbose = FALSE)
```

# Unfiltered/raw data

## Counts CDF

```{r}
qc_cdf(gimap_dataset)
```

## Histogram of cpm values by sample

```{r}
qc_sample_hist(gimap_dataset)
```


## Sample Correlation heatmap (unfiltered data)

```{r}
qc_cor_heatmap(gimap_dataset)
```

# Looking at filters for the data

## Zero count filter

This first filter looks at which pgRNA constructs have a raw count of zero for any of the samples

```{r}
qc_filter_zerocounts(gimap_dataset)
```

## Low plasmid cpm filter

This second filter considers the plasmid (the first sample or 0 time point) and the CPM at that time point. If a cutoff isn't provided by a user, the cutoff is determined by using the quantiles of the available plasmid CPMs.


The distribution of those plasmid CPMs are shown in the histogram below.

```{r}
qc_plasmid_histogram(gimap_dataset)
```

```{r}
list_of_qc_things$plasmid_hist_nocutoff
```

The stats used to find the cutoff are in this table

```{r}
list_of_qc_things$plasmid_stats
```

The distribution of those plasmid CPMs are shown in the histogram below, but this time, the suggested cutoff is a vertical dashed line.

```{r}
list_of_qc_things$plasmid_hist_cutoff
```

## Combining the two filters

When combining the filters, by default, if either of the filters raises a flag for a pgRNA construct, then the pgRNA is flagged to be filtered out.

```{r}
qc_combine_filters(counts_filter,
                   plasmid_filter,
                   use_combined = use_combined)
```

```{r}
list_of_qc_things$which_filter_df
```
