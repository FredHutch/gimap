---
title: "scratch gimap LFC & Normalization Review"
output: html_document
date: "`r Sys.Date()`"
---

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(devtools)
library(magrittr)
library(ggpubr)

devtools::load_all()
```

## Get the gimap Normalization/LFC results

```{r}
 gimap_dataset <- get_example_data("gimap") %>%
   gimap_filter() %>%
   gimap_annotate(cell_line = "HELA") %>%
   gimap_normalize(
     timepoints = "day")
```

## Load the GI Mapping Normalization/LFC results

Some data wrangling here. 

```{r}
d.counts_flagged <- read.table("d.HeLa_counts_cpm_flag_long.txt", header=TRUE)

d.annot <- read_tsv("HeLa_lfc_annot_adj_pgRNA.txt")

d.counts_flagged_timepoint <- d.counts_flagged %>%
  separate(sample, into = c("day", "rep"), sep = "_", remove = FALSE) %>%
  mutate(day = readr::parse_number(day),
         rep = str_replace(string = rep, pattern = "Rep", replacement = "")) %>%
  group_by(id) %>%
  mutate(timepoint = case_when(
    day == min(day) ~ "plasmid",
    day == max(day) ~ "late",
    TRUE ~ "early")) %>%
  ungroup()

d.counts_flagged_timepoint_early <- d.counts_flagged_timepoint %>%
  filter(timepoint == "plasmid" | timepoint == "early") %>%
  dplyr::select(id, timepoint, log2_cpm) %>%
  pivot_wider(names_from = timepoint, 
              values_from = log2_cpm,
              names_glue = "{timepoint}_{.value}")

d.counts_flagged_timepoint_lfc <- d.counts_flagged_timepoint %>%
  filter(timepoint == "late") %>% ## filter for only late timepoints
  left_join(d.counts_flagged_timepoint_early, by = "id") %>%
  mutate(lfc_plasmid_vs_late = log2_cpm - plasmid_log2_cpm)

d.lfc_annot <- d.counts_flagged_timepoint_lfc %>%
  left_join(d.annot, by = c("id" = "pgRNA_id")) %>%
  rename("pgRNA_id" = id)

d.lfc_annot <- d.lfc_annot %>%
  filter(rm_pgRNA == FALSE)

d.lfc_annot_adj <- d.lfc_annot %>%
  group_by(rep.x) %>%
  mutate(lfc_adj1 = lfc_plasmid_vs_late - median(lfc_plasmid_vs_late[norm_ctrl_flag == "negative_control"]),
         lfc_adj2 = lfc_adj1 / (median(lfc_adj1[norm_ctrl_flag == "negative_control"]) -
                                  median(lfc_adj1[norm_ctrl_flag == "positive_control"]))) %>%
  ungroup()

old_lfc_results <- d.lfc_annot_adj %>% select(pgRNA_id, rep = rep.x, paralog_pair, lfc_adj2, target_type:gene2_essential_flag)
```

### Negative and positive control medians 

We are expecting negative controls to be now set to a median of 0. 

For the original data: 
```{r}
old_neg_controls <- old_lfc_results %>%
  dplyr::filter(target_type == "ctrl_ctrl") %>%
  dplyr::group_by(rep) %>%
  dplyr::summarize(neg_ctrl_med = median(lfc_adj2)) %>%
  dplyr::pull(neg_ctrl_med)

old_neg_controls
```

For the new data: 
```{r}
new_neg_controls <- gimap_dataset$normalized_log_fc %>%
  dplyr::filter(target_type == "ctrl_ctrl", rep != "Day05_RepA_early") %>%
  dplyr::group_by(rep) %>%
  dplyr::summarize(neg_ctrl_med = median(lfc_adj)) %>%
  dplyr::pull(neg_ctrl_med)

new_neg_controls
```

We are expecting negative controls to be now set to a median of -1. 

For the original data: 
```{r}
old_pos_controls <- old_lfc_results %>%
  dplyr::filter(target_type %in% c("gene_ctrl", "ctrl_gene")) %>%
  dplyr::group_by(rep) %>%
  dplyr::summarize(pos_ctrl_med = median(lfc_adj2)) %>%
  dplyr::pull(pos_ctrl_med)

old_pos_controls
```

For the new data: 
```{r}
new_pos_controls <- gimap_dataset$normalized_log_fc %>%
  dplyr::filter(target_type %in% c("gene_ctrl", "ctrl_gene"), 
                rep != "Day05_RepA_early") %>%
  dplyr::group_by(rep) %>%
  dplyr::summarize(pos_ctrl_med = median(lfc_adj)) %>%
  dplyr::pull(pos_ctrl_med)

new_pos_controls
```

## Compare them

### Rows

```{r}
nrow(gimap_dataset$normalized_log_fc)
nrow(old_lfc_results)
setdiff(old_lfc_results$pgRNA_id, gimap_dataset$normalized_log_fc$pg_ids)
sum(gimap_dataset$normalized_log_fc$pg_ids == old_lfc_results$pgRNA_id)
```

The number of rows is more than 31817 which is the number of unique pgRNA IDs previously in the pipeline., but there aren't any pgRNA IDs present in one and not the other and the IDs seem to match row-wise. Each pgRNA ID is there in triplicate maybe? -- yes that seems to be the case because `unique(table(gimap_dataset$normalized_log_fc$pg_ids))` gives: `r unique(table(gimap_dataset$normalized_log_fc$pg_ids))`. Oh that's because there are 3 reps for each (A, B, and C for `old_lfc_results` and late_RepA, late_RepB, and late_RepC for `gimap_dataset$normalized_log_fc`) 

#### sync the reps values

```{r}
old_lfc_results %<>% mutate(
  rep = recode(rep, "A" = "Day22_RepA_late", "B" = "Day22_RepB_late", "C" = "Day22_RepC_late")
)
```

### Columns

```{r}
ncol(gimap_dataset$normalized_log_fc)
ncol(old_lfc_results)
print("Column names in new results not in old results")
setdiff(colnames(gimap_dataset$normalized_log_fc), colnames(old_lfc_results))
print("Column names in old results not in new results")
setdiff(colnames(old_lfc_results), colnames(gimap_dataset$normalized_log_fc))
```

| New results column name | Equivalent in old results |
|:-----------------------:|:-------------------------:|
| `pg_ids`                | `pgRNA_id`                |
| `log2_cn_gene1`         | `gene1_log2_cn`           |
| `log2_cn_gene2`         | `gene2_log2_cn`           |
| `log2_tpm_gene1`        | `gene1_log2_tpm`          |
| `lfc_adj`               | `lfc_adj2`                |

`plasmid_RepA`, `early_RepA`, `lfc_plasmid_vs_late` `unexpressed_control_flag` seem to be columns unique to the new results, not in the old results

`gene1_entrez_id` and `gene2_entrez_id` seem to be columns unique to the old results, not in the new results. (NOTE: but there are ensembl IDs in both, so I don't think this is a concern.)

```{r}
joindf <- dplyr::left_join(old_lfc_results, gimap_dataset$normalized_log_fc,
                           by = c("pgRNA_id" = "pg_ids", "rep"),
                           suffix = c("_old", "_new")) %>%
  select(pgRNA_id, new_calc = lfc_adj, org_calc = lfc_adj2, rep) %>% 
  dplyr::distinct()

joindf
```

```{r}
joindf %>% ggplot(aes(x=new_calc, y = org_calc)) +
  geom_point(alpha=0.1) +
  xlab("gimap Normalization/LFC") +
  ylab("GI Mapping Normalization/LFC") +
  theme_classic() +
  stat_regline_equation(label.y = 2.35) + stat_cor(label.y = 1.95) +
  facet_wrap(~rep)

```

```{r}
joindf %>% ggplot(aes(x=new_calc, y = org_calc)) +
  geom_point(alpha=0.1) +
  xlab("gimap Normalization/LFC: lfc_adj") +
  ylab("GI Mapping Normalization/LFC: lfc_adj2") +
  theme_classic() +
  stat_regline_equation(label.y = 2.35) + stat_cor(label.y = 1.95)

```

